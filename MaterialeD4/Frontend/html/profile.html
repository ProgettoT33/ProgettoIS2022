<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="/html/favicon.ico">
    <title>Stay Busy</title>
</head>
<body onload="showProfile()">
    <h1>Profilo</h1>
    <ul></ul>
    <form id="form">
        <input type="text" name="idtelegram" id="idtelegram" placeholder="ID Telegram">
        <button id="btn4">Cambia id telegram</button><br>
        <input type="text" name="description" id="description" placeholder="Descrizione">
        <button id="btn5">Cambia descrizione account</button><br>
        <input type="text" name="name" id="name" placeholder="Nome">
        <button id="btn6">Cambia nome</button><br>
        <input type="text" name="surname" id="surname" placeholder="Cognome">
        <button id="btn7">Cambia cognome</button><br>
        <input type="password" name="new" id="new" placeholder="Nuova password">
        <input type="password" name="newnew" id="newnew" placeholder="Conferma nuova password">
        <button id="btn8">Cambia password</button>
    </form>
    <br>
    <button id="btn1">Torna alla homepage</button>
    <button id="btn2">Cancella profilo</button>
    <button id="btn3">Cancella i miei annunci</button>
    <script></script>
</body>
<script>
    var url = window.location;

    var access_token = new URLSearchParams(url.search).get('token');
    var email = new URLSearchParams(url.search).get('email');

    const showProfile = () => {
        fetch('http://localhost:8080/api/offerer/emailO?email='+email)
        .then(res => {
            return res.json();
        })
        .then(data => {
        const markup = `
        <li>Nome : ${data.name}</li>
        <li>Cognome : ${data.surname}</li>
        <li>Email : ${data.email}</li>
        <li>ID Telegram : ${data.idtelegram}</li>
        <li>Descrizione : ${data.description}</li>
        <li>Media dei voti : ${data.averagevotes}</li>
        `

        document.querySelector('ul').insertAdjacentHTML('beforeend', markup);
        })
    }

    btn1.addEventListener('click', function(e){
      e.preventDefault();

      location.replace("http://localhost:8080/homepage?token="+access_token+"&email="+email)
    })

    btn2.addEventListener('click', function(e){
        e.preventDefault();

        fetch('http://localhost:8080/api/offerer/email?email='+email, {
            method : "DELETE"
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message === "NOT OK"){
                alert("Non puoi cancellare il tuo account, hai degli annunci ancora attivi");
                }else{
                    alert("Account cancellato correttamente");
                    location.replace('http://localhost:8080/');
                }
            })
            
        })
    })

    btn3.addEventListener('click', function(e){
      e.preventDefault();

      fetch('http://localhost:8080/api/announcement?email='+email, {
            method : "DELETE"
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message === "NOT OK"){
                alert("Attenzione, annunci non cancellati");
                }else{
                    alert("Annunci cancellati correttamente");
                }
            })
            
        })
    })

    btn4.addEventListener('click', function(e){
        e.preventDefault();
  
        const prePayload = new FormData(form);
        const payload = new URLSearchParams(prePayload);
        console.log([...payload]);


      fetch('http://localhost:8080/api/offerer/idtelegram?email='+email, {
            method : "POST",
            body : payload
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message != "NOT OK" && data.message != "OK"){
                    alert("Attenzione, ricontrolla i valori inseriti");
                }
                if(data.message === "NOT OK"){
                alert("Attenzione, modifiche non effettuate correttamente");
                }else{
                    alert("Modifiche effettuate correttamente");
                    location.replace("http://localhost:8080/profile?token="+access_token+"&email="+email);
                }
            })
            
        })
    })

    btn5.addEventListener('click', function(e){
        e.preventDefault();
  
        const prePayload = new FormData(form);
        const payload = new URLSearchParams(prePayload);
        console.log([...payload]);


      fetch('http://localhost:8080/api/offerer/description?email='+email, {
            method : "POST",
            body : payload
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message !== "NOT OK" && data.message !== "OK"){
                    alert("Attenzione, ricontrolla i valori inseriti");
                }
                if(data.message === "NOT OK"){
                alert("Attenzione, modifiche non effettuate correttamente");
                }else{
                    alert("Modifiche effettuate correttamente");
                    location.replace("http://localhost:8080/profile?token="+access_token+"&email="+email);
                }
            })
            
        })
    })

    btn6.addEventListener('click', function(e){
        e.preventDefault();
  
        const prePayload = new FormData(form);
        const payload = new URLSearchParams(prePayload);
        console.log([...payload]);


      fetch('http://localhost:8080/api/offerer/name?email='+email, {
            method : "POST",
            body : payload
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message != "NOT OK" && data.message != "OK"){
                    alert("Attenzione, ricontrolla i valori inseriti");
                }
                if(data.message === "NOT OK"){
                alert("Attenzione, modifiche non effettuate correttamente");
                }else{
                    alert("Modifiche effettuate correttamente");
                    location.replace("http://localhost:8080/profile?token="+access_token+"&email="+email);
                }
            })
            
        })
    })

    btn7.addEventListener('click', function(e){
        e.preventDefault();
  
        const prePayload = new FormData(form);
        const payload = new URLSearchParams(prePayload);
        console.log([...payload]);


      fetch('http://localhost:8080/api/offerer/surname?email='+email, {
            method : "POST",
            body : payload
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message != "NOT OK" && data.message != "OK"){
                    alert("Attenzione, ricontrolla i valori inseriti");
                }
                if(data.message === "NOT OK"){
                alert("Attenzione, modifiche non effettuate correttamente");
                }else{
                    alert("Modifiche effettuate correttamente");
                    location.replace("http://localhost:8080/profile?token="+access_token+"&email="+email);
                }
            })
            
        })
    })

    btn8.addEventListener('click', function(e){
        e.preventDefault();
  
        const prePayload = new FormData(form);
        const payload = new URLSearchParams(prePayload);
        console.log([...payload]);


      fetch('http://localhost:8080/api/offerer/password?email='+email, {
            method : "POST",
            body : payload
        })
        .then(res => {
            return res.json().then(data => {
                console.log(data);
                if(data.message != "NOT OK" && data.message != "OK"){
                    alert("Attenzione, ricontrolla i valori inseriti");
                }
                if(data.message === "NOT OK"){
                alert("Attenzione, modifiche non effettuate correttamente");
                }else{
                    alert("Modifiche effettuate correttamente");
                    location.replace("http://localhost:8080/profile?token="+access_token+"&email="+email);
                }
            })
            
        })
    })
</script>
</html>